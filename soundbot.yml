---

- hosts: all
  strategy: free
  tags: ['base']
  gather_facts: no
  vars:
    env_vars:
      ZSH: "{{ user.zsh }}"
      PATH: "{{ ansible_env.PATH }}:{{ path|join(':') }}"

  pre_tasks:
    - name: gather facts
      setup:
        gather_subset:
          - os_family
          - pkg_mgr

  tasks:
    - name: Check whether this is an initial install or not.
      stat:
        path: "{{ user.home }}/.installed"
      register: check_installed

    - name: touch .installed in user home directory
      file:
        path: "{{ user.home }}/.installed"
        state: touch
      register: installed
      when: not check_installed.stat.exists
      become: True
      become_user: "{{ user.name }}"

    - name: Reboot on initial setup
      shell: "shutdown -r now"
      when: not check_installed.stat.exists
      ignore_errors: True

    - name: print hostname
      debug: msg="inventory_hostname={{inventory_hostname}}"
      tags: ['inventory']

  roles:
     - { role: distro, tags: ['distro'] }
     - { role: networking, tags: ['networking'] }
     - { role: base, tags: ['base'] }

- hosts: desktop
  strategy: free
  tags: ['desktop']
  gather_facts: yes
  vars:
    env_vars:
      ZSH: "{{ user.zsh }}"
      PATH: "{{ ansible_env.PATH }}:{{ path|join(':') }}"

  pre_tasks:
    - name: gather facts
      setup:
        gather_subset:
          - os_family
          - pkg_mgr
  roles:
     - { role: audio, tags: ['audio'] }
     - { role: ui, tags: ['ui', 'theme'] }
     - { role: builds, tags: ['builds'] }
