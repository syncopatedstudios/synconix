---

- name: Update user shell defined in group_vars/all
  user:
    name: "{{ item }}"
    shell: /bin/zsh
  with_items:
    - root
    - "{{ user.name }}"
  tags: ['zsh']

- name: Check if oh-my-zsh is already installed
  stat: path="/usr/share/oh-my-zsh"
  register: haziohymyzsh
  tags: ['ohmyzsh']

- block:
    - name: Clone oh-my-zsh
      git:
        repo: "https://github.com/ohmyzsh/ohmyzsh.git"
        dest: "{{ local_src }}/ohmyzsh"
        accept_hostkey: yes
        update: no
        force: no

    - name: Install oh-my-zsh
      shell: |
        export ZSH="/usr/share/oh-my-zsh" && \
        sh -c './install.sh --unattended'
      args:
        chdir: "{{ local_src }}/ohmyzsh/tools/"

  when: not haziohymyzsh.stat.exists

- name: Push zsh-maia-prompt
  copy:
    src: usr/share/zsh/zsh-maia-prompt
    dest: /usr/share/zsh/zsh-maia-prompt
    owner: root
    group: root
    mode: '0644'
    backup: yes
    directory_mode: no

- name: Push root shell config
  synchronize:
    src: "root/"
    dest: "/root/"
    recursive: yes
    mode: push
    delete: no
    checksum: yes
    perms: no
    rsync_opts: "--update"
  tags: ['dots']

- name: set perms for root home
  shell: "chown -R root:root /root"
