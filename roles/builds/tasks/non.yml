---

- name: check if non-mixer is already installed
  stat: path="/usr/local/bin/non-mixer"
  register: hazinonmixer

- name: set non dependencies to install
  set_fact:
    _packages: "{{ development.non }}"
  tags: ['packages']

- name: Install non dependencies
  import_role:
    name: pkg_manager
  vars:
    pkg_state: present
  tags: ['packages']

- block:
    - name: clone non
      git:
        repo: "{{ non['git'] }}"
        dest: "{{ local_src }}/non"
        accept_hostkey: yes
        update: no
        force: no
        recursive: no

    - name: configure non-mixer
      command: bash -lc "./waf configure --project=mixer && ./waf"
      args:
        chdir: "{{ local_src }}/non"

    - name: install non-mixer
      command: bash -lc "sudo ./waf install && ./waf clean"
      args:
        chdir: "{{ local_src }}/non"

    - name: archive the source folder
      archive:
        path: "{{ local_src }}/non"
        dest: "{{ local_src }}/non.tar.gz"
        format: gz

    - name: remove the build directory
      file:
        path: "{{ local_src }}/non"
        state: absent

  become: True
  become_user: "{{ user.name }}"
  when: not hazinonmixer.stat.exists
