---

- name: check if swami is already installed
  stat: path="/usr/bin/swami"
  register: haziswami
  tags: ['swami']

- name: set swami dependencies to install
  set_fact:
    _packages: "{{ builds.swami }}"
  tags: ['packages']

- name: Install swami dependencies
  import_role:
    name: pkg_manager
  vars:
    pkg_state: present
  tags: ['packages']

- block:
    - name: Clone libinstpatch
      git:
        repo: "{{ libinstpatch['git'] }}"
        dest: "{{ local_src }}/libinstpatch"
        accept_hostkey: yes
        update: no
        force: no

    - name: Build and install libinstpatch
      shell: |
        mkdir -pv build && cd build/

        cmake -DCMAKE_INSTALL_PREFIX:PATH=/usr ..

      args:
        chdir: "{{ local_src }}/libinstpatch"
      register: libinstpatch_cmake
      failed_when: libinstpatch_cmake.failed

    - name: make libinstpatch
      shell: "make -j$(nproc)"
      args:
        chdir: "{{ local_src }}/libinstpatch/build"
      register: libinstpatch_make
      failed_when: libinstpatch_make.failed

    - name: install libinstpatch
      shell: "sudo make install"
      args:
        chdir: "{{ local_src }}/libinstpatch/build"
      when: libinstpatch_make.rc == 0

  become: True
  become_user: "{{ user.name }}"
  when: not haziswami.stat.exists

- block:
    - name: Clone swami
      git:
        repo: "{{ swami['git'] }}"
        dest: "{{ local_src }}/swami"
        accept_hostkey: yes
        update: no
        force: no

    - name: Build and install swami
      shell: |
        mkdir -pv build && cd build/

        cmake -DCMAKE_INSTALL_PREFIX:PATH=/usr ..
      args:
        chdir: "{{ local_src }}/swami"
      register: swami_build
      failed_when: swami_build.failed

    - name: make swami
      shell: "make -j$(nproc)"
      args:
        chdir: "{{ local_src }}/swami/build"
      register: swami_make
      failed_when: swami_make.failed

    - name: install swami
      shell: "sudo make install"
      args:
        chdir: "{{ local_src }}/swami/build"
      when: swami_make.rc == 0

  rescue:
    - debug:
        msg: 'I caught an error, can do stuff here to fix it, :-)'

  become: True
  become_user: "{{ user.name }}"
  when: not haziswami.stat.exists
  tags: ['swami']
