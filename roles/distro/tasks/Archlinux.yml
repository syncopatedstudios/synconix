---

- name: Check if a system-release file exists
  stat: path="/etc/system-release"
  register: hazirelease

- name: Create link to os-release
  file:
    src: "/etc/os-release"
    dest: "/etc/system-release"
    owner: root
    group: root
    state: link
  when: not hazirelease.stat.exists

- name: push pacman conf
  template:
    src: etc/pacman.conf.j2
    dest: /etc/pacman.conf
    mode: '0644'
    owner: root
    group: root
    backup: yes
  tags: ['pacmanconf']

- name: push pacman mirrorlist
  template:
    src: etc/pacman.d/mirrorlist.j2
    dest: /etc/pacman.d/mirrorlist
    mode: '0644'
    owner: root
    group: root
    backup: yes
  tags: ['pacmanconf']

- name: install makepkg config
  copy:
    src: "etc/makepkg.conf"
    dest: "/etc/makepkg.conf"
    owner: root
    group: root
    mode: '0644'
    backup: yes
    directory_mode: no
  tags: ['makepkg']

- name: Check if a yay already exists
  stat: path="/usr/bin/yay"
  register: haziyay
  tags: ['yay']

- block:
    - name: Clone yay
      git:
        repo: "https://aur.archlinux.org/yay.git"
        dest: "{{ local_src }}/yay"
        accept_hostkey: yes
        update: no
        force: no

    - name: Make and install yay
      shell: "makepkg -si --noconfirm --needed"
      args:
        chdir: "{{ local_src }}/yay"

  become: True
  become_user: "{{ user.name }}"
  when: not haziyay.stat.exists
  tags: ['yay']

- block:
    - name: clean package cache
      shell: |
        yay -Sc --noconfirm

    - name: update aur packages
      shell: |
        yay -Syyuu --noconfirm --needed

  become: True
  become_user: "{{ user.name }}"
  tags: ['yay']

- name: remove packages
  pacman:
    name: "{{ remove }}"
    state: absent
    force: yes
    extra_args: --noconfirm
  tags: ['remove']
