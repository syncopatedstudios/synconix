---

- name: starting audio role
  debug:
    msg: "starting audio role"

- name: Include OS-specific variables.
  include_vars: "{{ ansible_os_family }}.yml"

- include: pulseaudio.yml
  tags: ['pulseaudio']

- name: remove pipewire-media-session
  shell: |
    pacman -Rdd pipewire-media-session --noconfirm
  tags: ['pipewire']
  ignore_errors: true

- name: set alsa & pipewire packages to install
  set_fact:
    _packages:
      - alsa-lib
      - alsa-plugins
      - alsa-tools
      - alsa-utils
      - helvum
      - pipewire
      - pipewire-alsa
      - pipewire-jack
      - pipewire-pulse
      - pipewire-v4l2
      - pipewire-zeroconf
      - wireplumber
  tags: ['packages', 'alsa', 'pipewire']

- name: install alsa & pipewire packages
  import_role:
    name: pkg_manager
  vars:
    pkg_state: present
  tags: ['packages', 'alsa', 'pipewire']

- include: alsa.yml
  tags: ['alsa']

- include: pipewire.yml
  tags: ['pipewire']

#-------------------------------------#

- block:
    - name: Set audio packages to install
      set_fact:
        _packages: "{{ (audio + plugins) }}"

    - name: Install audio packages
      import_role:
        name: pkg_manager
      vars:
        pkg_state: present
  tags: ['packages', 'audio']

- block:
    - name: Set daw packages to install
      set_fact:
        _packages: "{{ daw }}"

    - name: Install daw packages
      import_role:
        name: pkg_manager
      vars:
        pkg_state: present

  when: inventory_hostname in groups['desktops']
  tags: ['packages', 'audio', 'daw']

- name: makesfz and makeh2drumkit
  copy:
    src: "usr/local/bin/{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    owner: root
    group: root
    mode: '0755'
  with_items:
    - makeh2kit
    - makesfz
  tags: ['audio', 'utils']

- name: Sync .desktop files to /usr/local
  synchronize:
    src: "usr/local/share/applications/"
    dest: "/usr/local/share/applications/"
    recursive: yes
    mode: push
    delete: no
    checksum: yes
    perms: no
    rsync_opts: "--update"
  tags: ['audio', 'xdg']

- include: players.yml
  tags: ['players']
