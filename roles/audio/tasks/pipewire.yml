---

- name: Ensure pipewire config directory exists
  shell: "mkdir -pv /usr/share/{pipewire,wireplumber}"
  tags: ['pipewire', 'wireplumber']

- name: Sync pipewire configs
  synchronize:
    src: "usr/share/pipewire/"
    dest: "/usr/share/pipewire/"
    recursive: yes
    mode: push
    delete: no
    checksum: yes
    perms: no
    rsync_opts: "--update"
  register: pipe
  tags: ['pipewire']

- name: Sync wireplumber configs
  synchronize:
    src: "usr/share/wireplumber/"
    dest: "/usr/share/wireplumber/"
    recursive: yes
    mode: push
    delete: no
    checksum: yes
    perms: no
    rsync_opts: "--update"
  register: wireplumb
  tags: ['pipewire', 'wireplumber']

- name: Sync wireplumber template for main sound card
  template:
    src: "usr/share/pipewire/pipewire.conf.j2"
    dest: "/usr/share/pipewire/pipewire.conf"
    owner: root
    group: root
    mode: "0644"
    backup: yes
  tags: ['pipewire']

- name: Sync wireplumber template for main sound card
  template:
    src: "usr/share/wireplumber/main.lua.d/50-alsa-config.lua.j2"
    dest: "/usr/share/wireplumber/main.lua.d/50-alsa-config.lua"
    owner: root
    group: root
    mode: "0644"
    backup: yes
  tags: ['wireplumber']

- name: Restart pipewire services
  systemd:
    name: "{{ item }}"
    state: restarted
    daemon_reload: yes
    scope: user
  with_items:
    - pipewire
    - pipewire-pulse
    - pipewire.socket
    - wireplumber
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ user.uid }}"
  become: True
  become_user: "{{ user.name }}"
  when: pipe.changed or wireplumb.changed
  tags: ['pipewire', 'wireplumber']
