---

- name: set packages to install
  set_fact:
    _packages: "{{ pipewire }}"
  tags: ['packages']

- name: install pipewire
  import_role:
    name: pkg_manager
  vars:
    pkg_state: present
  when: "ansible_os_family == 'Archlinux'"
  tags: ['packages']


- block:
    - name: ensure pipewire config directory exists
      shell: "mkdir -pv {{ user.home }}/.config/pipewire"

    - name: Push pipewire configs
      synchronize:
        src: "dots/config/pipewire/"
        dest: "{{ user.home }}/.config/pipewire/"
        recursive: yes
        mode: push
        delete: no
        checksum: yes
        perms: no
        rsync_opts: "--update"
      tags: ['piepwire']

    - name: enable pipewire services
      systemd:
        name: pipewire
        state: restarted
        scope: user

    # - name: enable wireplumber services
    #   systemd:
    #     name: wireplumber
    #     state: restarted
    #     scope: user

  become: True
  become_user: "{{ user.name }}"




# - name: remove pipewire
#   shell: |
#     pamac remove --no-confirm --no-upgrade {{ item }}
#   with_items:
#     - "{{ _packages }}"
#   when: "ansible_os_family == 'Archlinux'"
#   tags: ['packages']
