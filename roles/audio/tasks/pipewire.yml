---

- name: ensure pipewire config directory exists
  shell: "mkdir -pv /usr/share/{pipewire,wireplumber}"
  tags: ['pipewire', 'wireplumber']

- name: Push pipewire configs
  synchronize:
    src: "usr/share/pipewire/"
    dest: "/usr/share/pipewire/"
    recursive: yes
    mode: push
    delete: no
    checksum: yes
    perms: no
    rsync_opts: "--update"
  tags: ['pipewire']

- name: Push wireplumber configs
  synchronize:
    src: "usr/share/wireplumber/"
    dest: "/usr/share/wireplumber/"
    recursive: yes
    mode: push
    delete: no
    checksum: yes
    perms: no
    rsync_opts: "--update"
  tags: ['pipewire', 'wireplumber']

- block:
    - name: restart pipewire services
      systemd:
        name: "{{ item }}"
        state: restarted
        daemon_reload: yes
        scope: user
      with_items:
        - pipewire
        - pipewire-pulse
        - pipewire.socket
        - wireplumber
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ user.uid }}"
  become: True
  become_user: "{{ user.name }}"
  tags: ['pipewire', 'wireplumber']
