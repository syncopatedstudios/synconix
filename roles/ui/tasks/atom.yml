---

# https://github.com/atom/atom/releases
- name: check if atom is already installed
  stat: path="/usr/bin/atom"
  register: haziatom
  check_mode: no

- block:
    - name: gather list of installed apm packages
      shell: |
        apm list --installed --bare 2>&1 | xargs -0 | awk '{ print $1}'
      register: apmlist
      check_mode: no
      ignore_errors: yes

    - name: install atom plugins
      shell: |
        apm install {{ item }}
      args:
        warn: no
      when: item not in apmlist.stdout
      with_items:
        - "{{ apm }}"

    - name: Push atom config and stylesheets
      synchronize:
        src: dots/atom/
        dest: "{{ user.home }}/.atom/"
        recursive: yes
        mode: push
        delete: no
        checksum: yes
        perms: no
        rsync_opts: "--update"

  become: True
  become_user: "{{ user.name }}"
  when: haziatom.stat.exists
