---

- name: Update user shell defined in group_vars/all
  user:
    name: "{{ item }}"
    shell: /bin/zsh
  with_items:
    - root
    - "{{ user.name }}"
  tags: ['zsh']

- name: Check if oh-my-zsh is already installed
  stat: path="/usr/share/oh-my-zsh"
  register: haziohymyzsh
  tags: ['ohmyzsh']

- block:
    - name: Clone oh-my-zsh
      git:
        repo: "https://github.com/ohmyzsh/ohmyzsh.git"
        dest: "{{ local_src }}/ohmyzsh"
        accept_hostkey: yes
        update: no
        force: no

    - name: Install oh-my-zsh
      shell: |
        export ZSH="/usr/share/oh-my-zsh" && \
        sh -c './install.sh --unattended'
      args:
        chdir: "{{ local_src }}/ohmyzsh/tools/"

  when: not haziohymyzsh.stat.exists

- name: create zsh custom themes dir
  file:
    path: /usr/share/oh-my-zsh/custom/themes
    state: directory
    mode: '0775'
  tags: ['dots']

- name: Push oh-my-zsh-theme
  copy:
    src: "usr/share/oh-my-zsh/themes/{{ zsh.theme }}.zsh-theme"
    dest: "/usr/share/oh-my-zsh/themes/{{ zsh.theme }}.zsh-theme"
    mode: '0644'
    backup: yes
    directory_mode: no
  tags: ['dots']

- name: set root shell to zsh
  user:
    name: root
    shell: /bin/zsh
    state: present
  tags: ['dots']

- name: Push root shell config
  synchronize:
    src: "root/"
    dest: "/root/"
    recursive: yes
    mode: push
    delete: no
    checksum: yes
    perms: no
    rsync_opts: "--update"
  tags: ['dots']

- name: set perms for root home
  shell: "chown -R root:root /root"
  tags: ['dots']
