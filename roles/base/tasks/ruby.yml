---

- name: install system gemrc
  copy:
    src: etc/gemrc
    dest: /etc/gemrc
    directory_mode: no
    owner: root
    group: root
    mode: '0644'
    backup: yes

#TODO: account for using RVM

- name: Get list of installed gems
  shell: |
    gem list | awk '{ print $1 }'
  register: gemlist
  ignore_errors: yes

- set_fact:
    installed_gems: "{{ gemlist.stdout }}"

- name: determine gems that need to be installed
  set_fact:
    _gems: "{{ gems|difference(installed_gems) }}"

- name: install ruby gems
  shell: |
    sudo gem install {{ item }} --no-user-install
  with_items:
    - "{{ _gems }}"
  when: _gems | length > 0
  become: True
  become_user: "{{ user.name }}"
