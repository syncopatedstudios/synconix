---

- name: check if ardour is already installed
  stat: path="/usr/local/bin/ardour"
  register: haziardour
  tags: ['ardour']

- block:
    - name: set packages to install
      set_fact:
        _packages: "{{ builds.ardour }}"
      tags: ['packages']

    - name: Ensure all the required packages are installed
      import_role:
        name: pkg_manager
      vars:
        pkg_state: present
      tags: ['packages']

    - name: build ardour
      shell: |
        git clone {{ ardour.url }}

        cd ardour/

        CC=/usr/bin/clang CXX=/usr/bin/clang++ ./waf configure --denormal-exception --no-phone-home --canvasui --freedesktop --optimize --thread-sanitizer --docs

        ./waf

        ./waf install && ./waf clean

      args:
        chdir: "{{ local_src }}"
      register: ardour_build
      failed_when: ardour_build.failed

  when: not haziardour.stat.exists
