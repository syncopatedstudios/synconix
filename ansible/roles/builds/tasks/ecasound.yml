---

- name: check if ecasound is already installed
  stat: path="/usr/bin/ecasound"
  register: haziecasound
  tags: ['ecasound']

- name: set ecasound dependencies to install
  set_fact:
    _packages: "{{ builds.ecasound }}"
  tags: ['packages']

- name: Install ecasound dependencies
  import_role:
    name: pkg_manager
  vars:
    pkg_state: present
  tags: ['packages']

- block:
    - block:
        - name: Fetch ecasound
          get_url:
            url: "{{ ecasound.url }}{{ ecasound.file }}"
            dest: "{{ local_src }}"
            validate_certs: no

        - name: Extract, build and install ecasound
          shell: |
            tar -xvf {{ ecasound.file }}

            cd ecasound-2.9.3/

            LIBLILV_CFLAGS=`pkg-config --cflags lilv-0` LIBLILV_LIBS=`pkg-config\n--libs lilv-0` ./configure --prefix=/usr

            gmake && sudo gmake install

          args:
            chdir: "{{ local_src }}"
          register: ecasound_build
          failed_when: ecasound_build.failed

      become: True
      become_user: "{{ user.name }}"

  when: not haziecasound.stat.exists
