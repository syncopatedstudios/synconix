---
# fmt 8.0.1-2 works
# fmt 8.1.1-2 does not

- name: check if patchage is already installed
  shell: command -v patchage
  register: hazipatchage
  changed_when: hazipatchage.rc != 0
  check_mode: no
  ignore_errors: yes

- block:
    - name: set patchage dependencies to install
      set_fact:
        _packages: "{{ builds.drobilla }}"
      tags: ['packages']

    - name: Install patchage dependencies
      import_role:
        name: pkg_manager
      vars:
        pkg_state: present
      tags: ['packages']

    - name: clone patchage
      git:
        repo: "{{ patchage['git'] }}"
        dest: "{{ local_src }}/patchage"
        accept_hostkey: yes
        update: no
        force: no
        recursive: yes
      check_mode: no

    - name: configure patchage
      command: bash -lc "./waf configure --prefix=/usr && ./waf"
      args:
        chdir: "{{ local_src }}/patchage"

    - name: install patchage
      command: bash -lc "sudo ./waf install && ./waf clean"
      args:
        chdir: "{{ local_src }}/patchage"

    - name: archive the source folder
      archive:
        path: "{{ local_src }}/patchage"
        dest: "{{ local_src }}/patchage.tar.gz"
        format: gz

  become: True
  become_user: "{{ user.name }}"
  when: hazipatchage.rc != 0
