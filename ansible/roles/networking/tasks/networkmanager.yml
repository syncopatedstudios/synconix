---

- name: set packages to install
  set_fact:
    _networkmanager: "{{ networkmanager|difference(installed_packages) }}"
  tags: ['packages']

- name: install networkmanager stuff
  shell: "{{ ansible_pkg_mgr }} -y install {{ _networkmanager | join(' ') }}"
  when: _networkmanager | length > 0
  tags: ['packages']

- name: Push connectivity check config
  template:
      src: etc/NetworkManager/conf.d/connectivity.conf.j2
      dest: /etc/NetworkManager/conf.d/20-connectivity.conf
  when: conn_check is defined

- name: Enable and start NetworkManager
  systemd:
    name: NetworkManager.service
    enabled: yes
    state: started

- name: Enable and start NetworkManager dispatcher
  systemd:
    name: NetworkManager-dispatcher.service
    enabled: yes
    state: started

- name: Disable dhcpcd service
  systemd:
    name: dhcpcd
    enabled: no
  ignore_errors: True
