---

- name: check if ecasound is already installed
  stat: path="/usr/bin/ecasound"
  register: haziecasound
  tags: ['ecasound']

- block:
    - name: Set ecasound packages to install
      set_fact:
        _dev_ecasound: "{{ development['ecasound'] | difference(installed_packages) }}"
      tags: ['packages']

    - name: Install ecasound dependencies
      shell: "{{ __ansible_pkg_mgr_install }} {{ _dev_ecasound | join(' ') }}"
      when: _dev_ecasound | length > 0

    - block:
        - name: Fetch ecasound
          get_url:
            url: "{{ ecasound.url }}{{ ecasound.file }}"
            dest: "{{ local_src }}"
            validate_certs: no

        - name: Extract, build and install ecasound
          shell: |
            tar -xvf {{ ecasound.file }}

            cd ecasound-2.9.3/

            LIBLILV_CFLAGS=`pkg-config --cflags lilv-0` LIBLILV_LIBS=`pkg-config\n--libs lilv-0` ./configure --prefix=/usr

            gmake && sudo gmake install

          args:
            chdir: "{{ local_src }}"
          register: ecasound_build
          failed_when: ecasound_build.failed

      become: True
      become_user: "{{ user.name }}"

  when: not haziecasound.stat.exists
