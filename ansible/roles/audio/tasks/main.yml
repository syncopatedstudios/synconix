---

- name: set sound service packages to install
  set_fact:
    _sound_services: "{{ (audio['alsa'] + audio['jack'] + audio['pulseaudio']) | difference(installed_packages) }}"
  tags: ['packages']

- name: set audio utility packages to install
  set_fact:
    _audio_utils: "{{ audio['utilities']|difference(installed_packages) }}"
  tags: ['packages']

- name: set graphical audio utility packages to install
  set_fact:
    _audio_gutils: "{{ audio['gutilities']|difference(installed_packages) }}"
  tags: ['packages']

- name: set audio plugin packages to install
  set_fact:
    _audio_plugins: "{{ audio['plugins']|difference(installed_packages) }}"
  tags: ['packages']

- include: pipewire.yml

- name: install sound services (alsa,jack,pulse)
  shell: "{{ ansible_pkg_mgr }} -y install {{ _sound_services | join(' ') }}"
  when: _sound_services | length > 0
  tags: ['packages']

- include: pulseaudio.yml

- name: push jack limits file
  copy:
    src: etc/security/limits.conf
    dest: /etc/security/limits.conf
    owner: root
    group: root
    mode: '0644'
  tags: ['tuning']

- name: Add user to audio group
  user:
    name: "{{ user.name }}"
    groups: audio
    append: yes
  tags: ['tuning']

- name: install makesfz and makeh2drumkit
  copy:
    src: "usr/local/bin/{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    owner: root
    group: root
    mode: '0755'
  with_items:
    - makeh2kit
    - makesfz
  tags: ['soundfonts']

- name: install cli audio utilities
  shell: "{{ ansible_pkg_mgr }} -y install {{ _audio_utils | join(' ') }}"
  when: "audio_utilities|bool and _audio_utils | length > 0"
  tags: ['packages']

- name: install graphical audio utilities
  shell: "{{ ansible_pkg_mgr }} -y install {{ _audio_gutils | join(' ') }}"
  when: "audio_gutilities|bool and _audio_gutils | length > 0"
  tags: ['packages']

- name: install plugins
  shell: "{{ ansible_pkg_mgr }} -y install {{ _audio_plugins | join(' ') }}"
  when: "audio_plugins|bool and _audio_plugins | length > 0"
  tags: ['packages']

- include: ardour.yml
  tags: ['ardour']
  when: ardour.install|bool

- include: baudline.yml
  when: Baudline.install|bool
  tags: ['baudline']

- include: deadbeef.yml
  when: DeadBeef.install|bool
  tags: ['deadbeef']

- include: ecasound.yml
  when: ecasound.install|bool
  tags: ['ecasound']

- include: jacktrip.yml
  when: jacktrip.install|bool
  tags: ['jacktrip']

- include: jalvselect.yml
  when: raysession.install|bool
  tags: ['jalvselect']

- include: njconnect.yml
  when: njconnect.install|bool
  tags: ['njconnect']

- include: obs-studio.yml
  when: obs|bool
  tags: ['obs']

- include: ocenaudio.yml
  when: "ocenaudio.install|bool and 'ocenaudio' not in installed_packages"
  tags: ['ocenaudio']

- include: qmidinet.yml
  when: qmidinet.install|bool
  tags: ['qmidinet']

- include: raysession.yml
  when: raysession.install|bool
  tags: ['raysession']

- include: reaper.yml
  when: reaper.install|bool
  tags: ['reaper']

- include: rtplugins.yml
  when: rtplugins.install|bool
  tags: ['rtplugins']

- include: sonic-lineup.yml
  when: SonicLineup.install|bool
  tags: ['sonic-lineup']

- include: sonic-pi.yml
  when: SonicPi.install|bool
  tags: ['sonic-pi']

- include: sonic-pi-tool.yml
  when: SonicPi.install|bool
  tags: ['sonic-pi-tool']

- include: sonic-visualiser.yml
  when: SonicVisualiser.install|bool
  tags: ['sonic-visualiser']

- include: swami.yml
  when: swami.install|bool
  tags: ['swami']

- include: tony.yml
  when: Tony.install|bool
  tags: ['tony']

- include: touchosc.yml
  when: TouchOSC.install|bool
  tags: ['TouchOSC']
