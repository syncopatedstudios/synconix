---

- name: check if swami is already installed
  stat: path="/usr/bin/swami"
  register: haziswami
  tags: ['swami']

- block:
    - name: set swami packages to install
      set_fact:
        _dev_swami: "{{ development['swami'] | difference(installed_packages) }}"

    - name: Install swami dependencies
      shell: "{{ ansible_pkg_mgr }} -y install {{ _dev_swami | join(' ') }}"
      when: _dev_swami | length > 0

    - block:
        - name: Clone libinstpatch
          git:
            repo: "{{ libinstpatch['git'] }}"
            dest: "{{ local_src }}/libinstpatch"
            accept_hostkey: yes
            update: no
            force: no

        - name: Build and install libinstpatch
          shell: |
            mkdir -pv build && cd build/

            cmake -DCMAKE_INSTALL_PREFIX:PATH=/usr ..

            make && sudo make install
          args:
            chdir: "{{ local_src }}/libinstpatch"
          register: libinstpatch_build
          failed_when: libinstpatch_build.failed

  become: True
  become_user: "{{ user.name }}"
  when: not haziswami.stat.exists
  tags: ['libinstpatch']

- block:
    - name: Clone swami
      git:
        repo: "{{ swami['git'] }}"
        dest: "{{ local_src }}/swami"
        accept_hostkey: yes
        update: no
        force: no

    - name: Build and install swami
      shell: |
        mkdir -pv build && cd build/

        cmake -DCMAKE_INSTALL_PREFIX:PATH=/usr ..

        make && sudo make install
      args:
        chdir: "{{ local_src }}/swami"
      register: swami_build
      failed_when: swami_build.failed

  rescue:
    - debug:
        msg: 'I caught an error, can do stuff here to fix it, :-)'

  become: True
  become_user: "{{ user.name }}"
  when: not haziswami.stat.exists
  tags: ['swami']
