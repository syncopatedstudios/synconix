---

- name: check if ardour is already installed
  stat: path="/usr/local/bin/ardour"
  register: haziardour
  tags: ['ardour']

- block:
    - name: set packages to install
      set_fact:
        _dev_ardour: "{{ development['ardour']|difference(installed_packages) }}"
      tags: ['packages']

    - name: install ardour deps
      shell: "{{ __ansible_pkg_mgr_install }} {{ _dev_ardour | join(' ') }}"
      when: _dev_ardour | length > 0
      tags: ['packages']

    - name: build ardour
      shell: |
        git clone {{ ardour.url }}

        cd ardour/

        CC=/usr/bin/clang CXX=/usr/bin/clang++ ./waf configure --denormal-exception --no-phone-home --canvasui --freedesktop --optimize --thread-sanitizer --docs

        ./waf

        ./waf install && ./waf clean

      args:
        chdir: "{{ local_src }}"
      register: ardour_build
      failed_when: ardour_build.failed

  when: not haziardour.stat.exists
