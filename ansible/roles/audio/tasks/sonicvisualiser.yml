---

- name: check if sonicvisualiser is already installed
  stat: path="/usr/local/bin/sonic-visualiser"
  register: hazivisualiser
  tags: ['sonicvisualiser']

- block:
    - name: set sonic-visualiser dependencies to install
      set_fact:
        _dev_sonicvisualiser: "{{ development['sonicvisualiser']|difference(installed_packages) }}"
      tags: ['packages']

    - name: install sonicvisualiser deps
      shell: "{{ ansible_pkg_mgr }} -y install {{ _dev_sonicvisualiser | join(' ') }}"
      when: _dev_sonicvisualiser | length > 0
      tags: ['packages']

    - block:
        - name: clone sonicvisualiser
          git:
            repo: "{{ sonicvisualiser['git'] }}"
            dest: "/usr/local/src/sonicvisualiser"
            accept_hostkey: yes
            update: no
            force: no

        - name: build sonicvisualiser
          shell: |
            ./repoint install

            meson build

            cd build/ && ninja

            sudo meson install
          args:
            chdir: "/usr/local/src/sonicvisualiser"
          register: sv_build
          failed_when: sv_build.failed

      become: True
      become_user: "{{ user.name }}"

  when: not hazivisualiser.stat.exists
