---

- name: check if sonicvisualiser is already installed
  stat: path="/usr/local/bin/sonic-visualiser"
  register: hazivisualiser
  tags: ['sonicvisualiser']

- block:
    - name: set packages to install
      set_fact:
        _packages: "{{ development.sonicvisualiser| join(',') }}"
      tags: ['packages']

    - name: Ensure all the required packages are installed
      import_role:
        name: pkg_manager
      vars:
        pkg_state: present
      tags: ['packages']

    - block:
        - name: clone sonicvisualiser
          git:
            repo: "{{ sonicvisualiser['git'] }}"
            dest: "/usr/local/src/sonicvisualiser"
            accept_hostkey: yes
            update: no
            force: no

        - name: build sonicvisualiser
          shell: |
            ./repoint install

            meson build

            cd build/ && ninja

            sudo meson install
          args:
            chdir: "/usr/local/src/sonicvisualiser"
          register: sv_build
          failed_when: sv_build.failed

      become: True
      become_user: "{{ user.name }}"

  when: not hazivisualiser.stat.exists
