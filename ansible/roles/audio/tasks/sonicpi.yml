---

- name: check if sonicpi is already installed
  stat: path="/opt/sonicpi/app/build/gui/qt/sonicpi"
  register: hazisonicpi
  tags: ['sonicpi']

- name: set packages to install
  set_fact:
    _dev_sonicpi: "{{ development['sonicpi']|difference(installed_packages) }}"
  tags: ['packages']

- name: install dependencies for SonicPi
  shell: "{{ ansible_pkg_mgr }} -y install {{ _dev_sonicpi | join(' ') }}"
  when: _dev_sonicpi | length > 0
  tags: ['packages']

- block:
  - name: clone sonicpi
    git:
      repo: "{{ sonicpi['git'] }}"
      dest: "{{ sonicpi['path'] }}"
      accept_hostkey: yes
      update: no
      force: no

  - name: checkout releasev3.3 branch
    shell: "git checkout {{ sonicpi['branch'] }}"
    args:
      chdir: "{{ sonicpi['path'] }}"

  - name: checkout releasev3.3 branch for fedora
    shell: "git checkout v3.3-release_fedora"
    args:
      chdir: "{{ sonicpi['path'] }}"
    when: "ansible_facts['os_family'] == 'RedHat'"

  - name: run pre-build
    shell: |
      echo -e "\n change into the app directory"
      cd app/

      echo -e "\n running linux-prebuild"

      if {{ sonicpi['prebuild'] }} ; then
        echo -e "\n prebuild success! now running linux-config"
        {{ sonicpi['compile'] }}
      else
        echo -e "\n build failed"
      fi
    args:
      chdir: "{{ sonicpi['path'] }}"
    register: sonicpi_prebuild
    tags: ['sonicpi_prebuild']

  - name: build sonicpi
    shell: |
      echo -e "\n change into the build directory"

      cd app/build/

      make
    args:
      chdir: "{{ sonicpi['path'] }}"
    register: sonicpi_build

  # - debug: msg="{{ sonicpi_prebuild.stdout_lines }}"
  # - debug: msg="{{ sonicpi_build.stdout_lines }}"

  become: True
  become_user: "{{ user.name }}"
  when: not hazisonicpi.stat.exists
