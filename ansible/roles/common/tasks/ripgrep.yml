---

- name: check if ripgrep-all is already installed
  stat: path="/usr/local/bin/rga"
  register: hazirga

- name: set packages to install
  set_fact:
    _ripgrep: "{{ ripgrep|difference(installed_packages) }}"
  tags: ['packages']

- name: install ripgrep deps
  shell: "{{ ansible_pkg_mgr }} -y install {{ _ripgrep | join(' ') }}"
  when: _ripgrep | length > 0
  tags: ['packages']

- block:
    - name: fetch ripgrep
      get_url:
        url: https://github.com/BurntSushi/ripgrep/releases/download/13.0.0/ripgrep_13.0.0_amd64.deb
        dest: "{{ local_src }}"

    - name: install ripgrep
      shell: |
        apt -y install ./ripgrep_13.0.0_amd64.deb
      args:
        chdir: "{{ local_src }}"
  become: True
  become_user: "{{ user.name }}"
  when: ansible_os_family == 'Debian' or ansible_os_family == 'Zorin OS'


- block:
    - name: fetch ripgrep-all
      get_url:
        url: https://github.com/phiresky/ripgrep-all/releases/download/v0.9.6/ripgrep_all-v0.9.6-x86_64-unknown-linux-musl.tar.gz
        dest: "{{ local_src }}"

    - name: install ripgrep-all
      shell: |
        tar -xvf ripgrep_all-v0.9.6-x86_64-unknown-linux-musl.tar.gz
        cd ripgrep_all-v0.9.6-x86_64-unknown-linux-musl/
        ln -s /usr/local/src/ripgrep_all-v0.9.6-x86_64-unknown-linux-musl/rga /usr/local/bin/rga
      args:
        chdir: "{{ local_src }}"
  when: not hazirga.stat.exists
