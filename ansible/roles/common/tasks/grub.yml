---

- name: push default grub file
  template:
    src: etc/default/grub.j2
    dest: /etc/default/grub
    owner: root
    group: root
    mode: '644'
    backup: yes
  tags: ['grub']
  register: result

#TODO: dynamically set grub cfg location
- block:
    - name: reload grub
      shell: |
        grub2-mkconfig -o {{ grub_cfg }}

    - name: Reboot after system update
      shell: "shutdown -r now"

    - name: wait for reboot complete before moving on
      wait_for_connection:
        connect_timeout: 5
        delay: 5
        sleep: 5
        timeout: 300

  when: "ansible_facts['os_family'] == 'RedHat' and result.changed"
  check_mode: no
