---

- name: set packages to install
  set_fact:
    _rtkernel: "{{ kernel|difference(installed_packages) }}"

- name: install rt-kernel
  shell: "{{ ansible_pkg_mgr }} -y install {{ _rtkernel | join(' ') }}"
  when: _rtkernel | length > 0
  register: rtkernel
  tags: ['rtkernel']

- name: push default grub file
  template:
    src: etc/default/grub.j2
    dest: /etc/default/grub
    owner: root
    group: root
    mode: '644'
    backup: yes
  tags: ['grub']
  register: grubcfg

- block:
    - name: set rt-kernel as default
      shell: "grub2-set-default 1 && grub2-mkconfig -o {{ grub_config }}"

    - name: Reboot if a different kernel was installed
      shell: "shutdown -r now"
      async: 1
      poll: 0
      ignore_errors: True

    - name: wait for reboot complete before moving on
      wait_for_connection:
        sleep: 5
        timeout: 300

  when: "rtkernel is changed or grubcfg is changed"
  tags: ['rtkernel']
