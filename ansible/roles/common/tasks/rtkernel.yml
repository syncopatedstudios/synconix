---

- name: Set kernel packages to install
  set_fact:
    _packages: "{{ kernel| join(',') }}"
  tags: ['packages']

- name: Install kernel packages
  import_role:
    name: pkg_manager
  vars:
    pkg_state: present
  tags: ['packages']

- name: push default grub file
  template:
    src: etc/default/grub.j2
    dest: /etc/default/grub
    owner: root
    group: root
    mode: '644'
    backup: yes
  tags: ['grub']
  register: grubcfg

- block:
    - name: set rt-kernel as default
      shell: "{{ grub_set_default }} 1 && {{ grub_cmd }} -o {{ grub_config }}"

    - name: Reboot if a different kernel was installed
      shell: "shutdown -r now"
      async: 1
      poll: 0
      ignore_errors: True
      register: reboot

    - name: wait for reboot complete before moving on
      local_action:
        module: wait_for
        host: "{{ inventory_hostname }}"
        state: started
        delay: 10
        timeout: 60
      when: reboot.changed

  when: package_results.changed or grubcfg.changed
  tags: ['rtkernel']
