---

- name: set kernel packages to install
  set_fact:
    _rtkernel: "{{ kernel|difference(installed_packages) }}"

- name: install rt-kernel
  shell: "{{ __ansible_pkg_mgr_install }} {{ _rtkernel | join(' ') }}"
  when: _rtkernel | length > 0
  register: rtkernel
  tags: ['rtkernel']

- name: push default grub file
  template:
    src: etc/default/grub.j2
    dest: /etc/default/grub
    owner: root
    group: root
    mode: '644'
    backup: yes
  tags: ['grub']
  register: grubcfg

- block:
    - name: set rt-kernel as default
      shell: "grub2-set-default 1 && grub2-mkconfig -o {{ grub_config }}"

    - name: Reboot if a different kernel was installed
      shell: "shutdown -r now"
      async: 1
      poll: 0
      ignore_errors: True
      register: reboot

    - name: wait for reboot complete before moving on
      local_action:
        module: wait_for
        host: "{{ inventory_hostname }}"
        state: started
        delay: 10
        timeout: 60
      when: reboot.changed

  when: "rtkernel is changed or grubcfg is changed"
  tags: ['rtkernel']
