---

- name: set packages to install
  set_fact:
    _rtkernel: "{{ kernel|difference(installed_packages) }}"

- name: install rt-kernel
  shell: "{{ ansible_pkg_mgr }} -y install {{ _rtkernel | join(' ') }}"
  when: _rtkernel | length > 0
  register: rtkernel
  tags: ['rtkernel']

- block:

    - name: set rt-kernel as default
      shell: "grub2-set-default 1 && grub2-mkconfig -o {{ grub_cfg }}"

    - name: Reboot if a different kernel was installed
      shell: "shutdown -r now"

    - name: wait for reboot complete before moving on
      wait_for_connection:
        sleep: 5
        timeout: 300

  when: rtkernel is changed
  tags: ['rtkernel']
