---

- name: gather facts
  setup:
    gather_subset:
      - os_family
      - pkg_mgr

- name: Include OS-specific variables.
  include_vars: "{{ ansible_os_family }}.yml"

- include: soundcard.yml
  tags: ['soundcard']

- include: sonicannotator.yml
  tags: ['sonicannotator']

- include: audiowaveform.yml
  tags: ['audiowaveform']

- name: ensure opt perms
  file:
    path: "/opt"
    state: directory
    mode: '2775'
    group: "{{ user.group }}"

- block:
    - name: check if soundbot is already installed
      stat: path="/opt/soundbot"
      register: hazisoundbot

    - block:
        - name: clone soundbot
          git:
            repo: "https://gitlab.com/syncopatedstudios/soundbot.git"
            dest: "/opt/soundbot"
            accept_hostkey: yes
            update: no
            force: no

        - name: checkout development branch
          shell: "git checkout development"
          args:
            chdir: "/opt/soundbot"
      when: not hazisoundbot.stat.exists

    # - name: check for Gemfile.lock
    #   stat: path="/opt/soundbot/Gemfile.lock"
    #   register: hazilock
    #
    # - name: run bundle install
    #   shell: "bundle install"
    #   args:
    #     chdir: /opt/soundbot
    #   when: not hazilock.stat.exists
    #
    # - name: run gem pristine if there is an issue with extensions
    #   shell: "sudo gem pristine --all"
    #   args:
    #     chdir: /opt/soundbot

  become: True
  become_user: "{{ user.name }}"

- include: dots.yml
  when: dots['repo'] is defined
