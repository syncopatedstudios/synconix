---

- include: soundcard.yml
  tags: ['soundcard']

- include: annotator.yml
  tags: ['sonic-annotator']

- include: audiowaveform.yml
  tags: ['audiowaveform']

- name: ensure opt perms
  file:
    path: "/opt"
    state: directory
    mode: '2775'
    group: "{{ user.group }}"

- block:
    - name: clone soundbot
      git:
        repo: "https://gitlab.com/syncopatedstudios/soundbot.git"
        dest: "/opt/soundbot"
        accept_hostkey: yes
        update: no
        force: no

    - name: check for Gemfile.lock
      stat: path="/opt/soundbot/Gemfile.lock"
      register: hazilock

    - name: run bundle install
      shell: "bundle install"
      args:
        chdir: /opt/soundbot
      when: not hazilock.stat.exists

    # - name: run gem pristine if there is an issue with extensions
    #   shell: "sudo gem pristine --all"
    #   args:
    #     chdir: /opt/soundbot

  become: True
  become_user: "{{ user.name }}"

- include: dots.yml
  when: dots['repo'] is defined
