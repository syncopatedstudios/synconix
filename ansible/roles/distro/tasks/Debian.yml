---

- name: Check if a system-release file exists
  stat: path="/etc/system-release"
  register: hazirelease

- name: Create link to os-release
  file:
    src: "/etc/os-release"
    dest: "/etc/system-release"
    owner: root
    group: root
    state: link
  when: not hazirelease.stat.exists

- name: Update apt cache
  shell: |
    apt clean all
    apt-get update -qq

- name: Install software-props to use apt-key
  apt:
    name: apt-transport-https
    state: present

- name: Gather list of currently installed repositories
  shell: |
    apt-cache policy | grep http | awk '{print $2 $3}' | sort -u
  register: aptrepos
  check_mode: no

- name: Install kxstudio repo package
  shell: |
    wget https://launchpad.net/~kxstudio-debian/+archive/kxstudio/+files/kxstudio-repos_10.0.3_all.deb

    dpkg -i ./kxstudio-repos_10.0.3_all.deb
  args:
    chdir: "{{ local_src }}"

  register: kx_ppa
  when: kx_repo|bool and 'kxstudio' not in aptrepos.stdout
  tags: ['kxrepo']

- name: Install the Liquorix repos
  shell: "curl 'https://liquorix.net/add-liquorix-repo.sh' | sudo bash"
  args:
    chdir: "{{ local_src }}"

  register: liquorix_ppa
  when: liquorix|bool and 'liquorix' not in aptrepos.stdout
  tags: ['kernel', 'liquorix']

- block:
    - name: Grab the nodejs deb repo setup script
      get_url:
        url: https://deb.nodesource.com/setup_12.x
        dest: /tmp/nodesource_setup.sh

    - name: Run nodejs repository setup script
      shell: |
        bash -x ./nodesource_setup.sh
      args:
        chdir: /tmp

  register: nodejs_ppa
  check_mode: no
  when: "'node' not in aptrepos.stdout"
  tags: ['nodejs']

- block:
    - name: Install gpg key for Atom repository
      shell: |
        wget -qO - https://packagecloud.io/AtomEditor/atom/gpgkey | sudo apt-key add -
      args:
        chdir: /tmp

    - name: Add atom ppa source config
      lineinfile:
        path: /etc/apt/sources.list.d/atom.list
        line: "deb [arch=amd64] https://packagecloud.io/AtomEditor/atom/any/ any main"
        create: yes

  register: atom_ppa
  when: atom|bool and 'atom' not in aptrepos.stdout

- block:
    - name: Install docker repo
      copy:
        src: etc/apt/sources.list.d/docker.list
        dest: /etc/apt/sources.list.d/docker.list
        owner: root
        group: root
        mode: '0644'
        directory_mode: no
        backup: yes
      register: docker_repo

      # todo : this doesn't work
    - name: Add the docker gpg key
      shell: |
        curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/ docker-archive-keyring.gpg
      args:
        chdir: /tmp
      tags: ['docker']
      when: docker_repo.changed

  register: docker_ppa
  when: docker|bool and 'docker' not in aptrepos.stdout
  tags: ['docker']

- block:
    - name: Install obs-studio ppa source
      shell: "add-apt-repository -y ppa:obsproject/obs-studio"

  register: obs_ppa
  when: obs|bool and 'obs' not in aptrepos.stdout
  tags: ['obs']

- block:
    - name: Install monogodb for debian systems
      shell: |
        wget -qO - https://www.mongodb.org/static/pgp/server-5.0.asc | apt-key add -

        echo "deb http://repo.mongodb.org/apt/debian buster/mongodb-org/5.0 main" | tee /etc/apt/sources.list.d/mongodb-org-5.0.list

        apt-get install -y mongodb-org

  register: monogodb_ppa
  when: monogodb|bool and 'mongodb' not in aptrepos.stdout
  tags: ['monogodb']

- name: update apt
  shell: "apt clean all && apt-get update -qq"
  when: >
    - (monogodb_ppa.changed) or
    - (obs_ppa.changed) or
    - (docker_ppa.changed) or
    - (atom_ppa.changed) or
    - (nodejs_ppa.changed) or
    - (kx_ppa.changed) or
    - (liquorix_ppa.changed)
