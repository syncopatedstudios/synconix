---

- block:

    - name: Gather list of currently installed packages
      shell: |
        apt list --installed | cut -f1 -d / | tr "\n" " "
      register: packagelist
      check_mode: no
      ignore_errors: yes

    - set_fact:
        installed_packages: "{{ packagelist.stdout }}"

  tags: ['common', 'devel', 'soundbot', 'ui', 'audio', 'packages']

- name: Setup some apt repositories
  import_tasks: apt.yml

---

- name: Check if a system-release file exists
  stat: path="/etc/system-release"
  register: hazirelease
  tags: ['kernel']

- name: Create link to os-release
  file:
    src: "/etc/os-release"
    dest: "/etc/system-release"
    owner: root
    group: root
    state: link
  tags: ['kernel']
  when: not hazirelease.stat.exists

- name: Update apt cache
  shell: |
    apt clean
    apt -y update
  when: apt_update|bool

- name: Install software-props to use apt-key
  apt:
    name: apt-transport-https
    state: present
  tags: ['apt']

- name: Gather list of currently installed repositories
  shell: |
    apt-cache policy | grep http | awk '{print $2 $3}' | sort -u
  register: aptrepos
  check_mode: no

- name: Grab the kxstudio repo package
  get_url:
    url: https://launchpad.net/~kxstudio-debian/+archive/kxstudio/+files/kxstudio-repos_10.0.3_all.deb
    dest: "{{ local_src }}"
  tags: ['kxrepo']
  when: kx_repo|bool and 'kxstudio' not in aptrepos.stdout

- name: Install kxstudio repo package
  shell: |
    dpkg -i ./kxstudio-repos_10.0.3_all.deb

    apt clean all

    apt update
  args:
    chdir: "{{ local_src }}"
  tags: ['kxrepo']
  when: kx_repo|bool and 'kxstudio' not in aptrepos.stdout

- name: Install the Liquorix repos
  shell: |
    curl 'https://liquorix.net/add-liquorix-repo.sh' | sudo bash

    apt clean all

    apt update
  args:
    chdir: "{{ local_src }}"
  tags: ['kernel', 'liquorix']
  when: liquorix|bool and 'liquorix' not in aptrepos.stdout

- block:
    - name: Grab the nodejs deb repo setup script
      get_url:
        url: https://deb.nodesource.com/setup_12.x
        dest: /tmp/nodesource_setup.sh

    - name: Run nodejs repository setup script
      shell: |
        bash -x ./nodesource_setup.sh
      args:
        chdir: /tmp

  tags: ['nodejs']
  when: "'node' not in aptrepos.stdout"
  check_mode: no

- block:
    - name: Install gpg key for Atom repository
      shell: |
        wget -qO - https://packagecloud.io/AtomEditor/atom/gpgkey | sudo apt-key add -
      args:
        chdir: /tmp

    - name: Add atom ppa source config
      lineinfile:
        path: /etc/apt/sources.list.d/atom.list
        line: "deb [arch=amd64] https://packagecloud.io/AtomEditor/atom/any/ any main"
        create: yes
      notify: apt update

  when: atom|bool and 'atom' not in aptrepos.stdout

- block:
    - name: Install docker repo
      copy:
        src: etc/apt/sources.list.d/docker.list
        dest: /etc/apt/sources.list.d/docker.list
        owner: root
        group: root
        mode: '0644'
        directory_mode: no
        backup: yes
      register: docker_repo

      # todo : this doesn't work
    - name: Add the docker gpg key
      shell: |
        curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/ docker-archive-keyring.gpg
      args:
        chdir: /tmp
      tags: ['docker']
      when: docker_repo.changed
      notify: apt update

  when: docker|bool and 'docker' not in aptrepos.stdout
  tags: ['docker']

- block:
    - name: Install obs-studio ppa source
      shell: |
        add-apt-repository -y ppa:obsproject/obs-studio

        apt -y update

  when: obs|bool and 'obs' not in aptrepos.stdout
  tags: ['obs']

- block:
    - name: Install monogodb for debian systems
      shell: |
        wget -qO - https://www.mongodb.org/static/pgp/server-5.0.asc | apt-key add -

        echo "deb http://repo.mongodb.org/apt/debian buster/mongodb-org/5.0 main" | tee /etc/apt/sources.list.d/mongodb-org-5.0.list

        apt -y update
        apt-get install -y mongodb-org

  when: monogodb|bool and 'mongodb' not in aptrepos.stdout
  tags: ['monogodb']
