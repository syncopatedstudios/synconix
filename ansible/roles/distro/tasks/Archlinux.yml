---

- name: install os-release
  copy:
    src: "etc/os-release"
    dest: "/etc/os-release"
    owner: root
    group: root
    mode: '0644'
    directory_mode: no

- name: install system-release
  copy:
    src: "etc/os-release"
    dest: "/etc/system-release"
    owner: root
    group: root
    mode: '0644'
    directory_mode: no

- name: push pamac conf
  template:
    src: etc/pamac.conf.j2
    dest: /etc/pamac.conf
    mode: '0644'
    owner: root
    group: root
    backup: yes
  tags: ['pamacconf']

- name: push pacman conf
  template:
    src: etc/pacman.conf.j2
    dest: /etc/pacman.conf
    mode: '0644'
    owner: root
    group: root
    backup: yes
  tags: ['pacmanconf']

- name: push pacman mirrorlist
  template:
    src: etc/pacman.d/mirrorlist.j2
    dest: /etc/pacman.d/mirrorlist
    mode: '0644'
    owner: root
    group: root
    backup: yes
  tags: ['pacmanconf']

- name: install makepkg config
  copy:
    src: "etc/makepkg.conf"
    dest: "/etc/makepkg.conf"
    owner: root
    group: root
    mode: '0644'
    backup: yes
    directory_mode: no
  tags: ['makepkg']

- name: Check if unix admin sudoers file already exists
  stat: "path=/etc/sudoers.d/10-installer"
  register: hazifile
  tags: ['sudoers']

- name: Add unix_admin.name to sudoers if it doesn't already exist
  lineinfile:
    path: /etc/sudoers.d/10-installer
    line: '{{ user.name }} ALL=(ALL:ALL) NOPASSWD: ALL'
    create: yes
    validate: 'visudo -cf %s'
  when: not hazifile.stat.exists
  tags: ['sudoers']

# - name: Check if a yay already exists
#   stat: path="/usr/bin/yay"
#   register: haziyay
#   tags: ['yay']

# - block:
#     - name: Clone yay
#       git:
#         repo: "https://aur.archlinux.org/yay-bin.git"
#         dest: "{{ local_src }}/yay"
#         accept_hostkey: yes
#         update: yes
#         force: no
#
#     - name: Make and install yay
#       shell: "makepkg -si --noconfirm --needed"
#       args:
#         chdir: "{{ local_src }}/yay"
#
#   become: True
#   become_user: "{{ user.name }}"
#   when: not haziyay.stat.exists
#   tags: ['yay']

- block:
    - name: clean package cache
      shell: |
        pamac clean

  become: True
  become_user: "{{ user.name }}"
  tags: ['pamac']

- name: remove packages
  pacman:
    name: "{{ remove }}"
    state: absent
    force: yes
    extra_args: --noconfirm
  tags: ['remove']
