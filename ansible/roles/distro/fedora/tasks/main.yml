---

- name: Disable SELinux
  selinux:
    state: disabled
  when: ansible_selinux['status'] == 'enabled'
  register: selinuxstatus

- name: Ensure compression, autodefrag, and noatime are enabled for btrfs mounts
  mount:
    path: "{{ item.mount }}"
    src: "UUID={{ item.uuid }}"
    fstype: "{{ item.fstype }}"
    opts: "{{ item.options }},compress=zstd:1,autodefrag,noatime"
    state: present
    backup: yes
  with_items:
    - "{{ ansible_mounts }}"
  when: "item.fstype == 'btrfs' and item.options.find('compress=zstd:1') == 0"
  register: fstab

- name: Reboot if selinux or fstab was changed
  command: shutdown -r now
  when: selinuxstatus.changed or fstab.changed
  async: 90
  poll: 5

- block:

    - name: get installed items list
      shell: |
        dnf list --installed | awk '{ print $1}'
      register: packagelist
      ignore_errors: yes

    - set_fact:
        installed_packages: "{{ packagelist.stdout }}"

  tags: ['common', 'devel', 'soundbot', 'ui', 'audio', 'packagelist']

- name: Setup Fedora repos
  import_tasks: dnf.yml
