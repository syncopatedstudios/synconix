---

- name: Disable SELinux
  selinux:
    state: disabled
  when: ansible_selinux['status'] == 'enabled'
  register: selinuxstatus

- name: Ensure compression, autodefrag, and noatime are enabled for btrfs mounts
  mount:
    path: "{{ item.mount }}"
    src: "UUID={{ item.uuid }}"
    fstype: "{{ item.fstype }}"
    opts: "{{ item.options }},compress=lzo,autodefrag,noatime"
    state: present
    backup: yes
  with_items:
    - "{{ ansible_mounts }}"
  when: "item.fstype == 'btrfs' and item.options.find('compress=lzo') == 0"
  register: fstab

- name: Reboot if selinux or fstab was changed
  shell: "shutdown -r now"
  async: 1
  poll: 0
  when: "selinuxstatus is changed or fstab is changed"

- name: Wait for reboot complete before moving on
  wait_for_connection:
    connect_timeout: 20
    sleep: 5
    delay: 5
    timeout: 300
  when: "selinuxstatus is changed or fstab is changed"

- block:

    - name: Get installed items list
      shell: |
        dnf list --installed | awk -F '.' '{ print $1}'
      register: packagelist
      ignore_errors: yes

    - set_fact:
        installed_packages: "{{ packagelist.stdout }}"

  tags: ['common', 'devel', 'soundbot', 'ui', 'audio', 'packagelist']

- name: Setup Fedora repos
  import_tasks: dnf.yml
