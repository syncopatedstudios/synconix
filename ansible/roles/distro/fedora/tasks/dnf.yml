---

- name: Get dnf repolist
  shell: "dnf repolist | awk '{ print $1}'"
  register: repolist
  ignore_errors: yes
  tags: ['sysinfo']

- name: Install dnf.conf with fastestmirror enabled
  copy:
    src: etc/dnf/dnf.conf
    dest: /etc/dnf/dnf.conf
    owner: root
    group: root
    mode: '0644'
    directory_mode: no
    backup: yes
  register: dnf_conf

- name: Install fedora workstation repos
  dnf:
    name: "fedora-workstation-repositories"
    state: present
  tags: ['repos']
  when: "'google-chrome' not in repolist.stdout"

- block:
    - name: Fetch rpmfusion repo rpms
      get_url:
        url: "{{ item }}"
        dest: "{{ local_src }}"
        validate_certs: yes
      with_items:
        - "{{ rpmfusion_nonfree['url'] }}{{ rpmfusion_nonfree['file'] }}"
        - "{{ rpmfusion_free['url'] }}{{ rpmfusion_free['file'] }}"

    - name: Install rpmfusion repos
      shell: "dnf -y install {{ item }} && sleep 0.5"
      args:
        chdir: "{{ local_src }}"
      with_items:
        - "{{ rpmfusion_nonfree['file'] }}"
        - "{{ rpmfusion_free['file'] }}"
      ignore_errors: True

  when: "'rpmfusion-free' not in repolist.stdout"

- block:
    - name: Fetch ccrma repo rpm
      get_url:
        url: "{{ ccrma_repo['url'] }}{{ ccrma_repo['file'] }}"
        dest: "{{ local_src }}"
        validate_certs: yes

    - name: Install ccrma repo
      shell:  "dnf -y install {{ ccrma_repo['file'] }} && sleep 0.5"
      args:
        chdir: "{{ local_src }}"

  when: "'planetccrma' not in repolist.stdout"

- name: Enable some copr repos
  shell: "dnf -y copr enable {{ item }}"
  with_items:
    - "ycollet/linuxmao"
  tags: ['repos', 'copr']
  when: "'linuxmao' not in repolist.stdout"

- name: Enable additional yum repositories atom and monogodb
  copy:
    src: "etc/yum.repos.d/{{ item }}"
    dest: "/etc/yum.repos.d/{{ item }}"
    owner: root
    group: root
    mode: '0644'
  with_items:
    - atom.repo
    - monogodb.repo

- name: Enable nodejs 14 module
  shell: "dnf -y module enable nodejs:14"
  tags: ['nodejs']

- block:
    - name: clean and update dnf
      shell: "dnf clean all && dnf -y update"
      args:
        executable: /bin/bash

    - name: Reboot after system update
      shell: "shutdown -r now"

    - name: wait for reboot complete before moving on
      wait_for_connection:
        delay: 5
        sleep: 5
        timeout: 300

  when: dnf_conf is changed
