---

- name: set desktop environment packages to install
  set_fact:
    _ui_i3: "{{ ui['i3']|difference(installed_packages) }}"
  tags: ['packages']

- name: Install i3 Window Manager and components
  shell: "{{ ansible_pkg_mgr }} -y install {{ _ui_i3 | join(' ') }}"
  when: _ui_i3 | length > 0
  tags: ['packages']

- name: check if swallow is already installed
  stat: path="/usr/local/bin/swallow"
  register: haziswallow

- name: clone i3-swallow
  git:
    repo: "{{ swallow['git'] }}"
    dest: "{{ local_src }}/swallow"
    accept_hostkey: yes
    update: no
    force: no
  when: not haziswallow.stat.exists

- name: move i3-swallow to bin dir
  shell: cp swallow /usr/local/bin/swallow
  args:
    chdir: "{{ local_src }}/swallow"
  when: not haziswallow.stat.exists

- block:
    - name: Ensure i3 config directory exists
      shell: |
        mkdir -pv {{ user.home }}/.config/i3
        mkdir -pv {{ user.home }}/.config/polybar
        mkdir -pv {{ user.home }}/.config/rofi

    - name: push i3 and polybar configs
      template:
        src: "dots/config/{{ item }}.j2"
        dest: "{{ user.home }}/.config/{{ item }}"
        owner: "{{ user.name }}"
        group: "{{ user.group }}"
        mode: "0644"
        backup: yes
      with_items:
        - "i3/config"
        - "polybar/config"

    - name: push rofi configs
      template:
        src: "dots/config/{{ item }}.j2"
        dest: "{{ user.home }}/.config/{{ item }}"
        owner: "{{ user.name }}"
        group: "{{ user.group }}"
        mode: "0644"
        backup: yes
      with_items:
        - "rofi/config.rasi"
        - "rofi/colors.rasi"

  become: True
  become_user: "{{ user.name }}"
