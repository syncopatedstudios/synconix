---

- name: Set kernel packages to install
  set_fact:
    _packages: "{{ base.kernel['lts'] }}"
  when: use_kernel == 'lts'

- name: Set kernel packages to install
  set_fact:
    _packages: "{{ base.kernel['rt'] }}"
  when: use_kernel == 'rt'

- name: Set kernel packages to install
  set_fact:
    _packages: "{{ base.kernel['zen'] }}"
  when: use_kernel == 'zen'

- name: push mkinitcpio configs
  template:
    src: "etc/mkinitcpio.conf.j2"
    dest: "/etc/mkinitcpio.conf"
    owner: root
    group: root
    mode: '644'
    backup: yes
  register: mkinit
  tags: ['initram']

- name: create an initial ramdisk environment.
  shell: |
    mkinitcpio -P
  when: mkinit.changed
  tags: ['initram']

- name: Install kernel packages
  import_role:
    name: pkg_manager
  vars:
    pkg_state: present
  register: package_results

- block:
    - name: push default grub file
      template:
        src: etc/default/grub.j2
        dest: /etc/default/grub
        owner: root
        group: root
        mode: '644'
        backup: yes
      register: default_grub

    - block:
        - name: Set linux-lts as the defaule in grub
          shell: "{{ grub_set_default }} 'Advanced options for Arch Linux>Arch Linux, with Linux linux-lts'"
          when: use_kernel == 'lts'

        - name: Set linux-zen as the defaule in grub
          shell: "{{ grub_set_default }} 'Advanced options for Arch Linux>Arch Linux, with Linux linux-zen'"
          when: use_kernel == 'zen'

        - name: remake grub
          shell: "{{ grub_cmd }} -o {{ grub_config }}"

      when: default_grub.changed

  tags: ['grub']
