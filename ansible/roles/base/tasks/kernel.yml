---

- block:

    - name: Install kernel packages.
      aur:
        use: auto
        name: "{{ _kernel_packages }}"
        state: present
      become: True
      become_user: "{{ user.name }}"
      when: _kernel_packages|length > 0

    - name: Add btrfs module in mkinitcpio.conf
      template:
        src: "etc/mkinitcpio.conf.j2"
        dest: "/etc/mkinitcpio.conf"
        owner: root
        group: root
        mode: '644'
        backup: yes
      register: mkinit
      tags: ['initram']

    - name: Rebuild ramdisk environment.
      shell: |
        mkinitcpio -P
      when: mkinit.changed
      tags: ['initram']

    - include: grub.yml
      tags: ['grub']

  when: ansible_lsb['id'] != 'Manjaro-ARM'
