---

- name: set no-user-install in gemrc
  lineinfile:
    dest: /etc/gemrc
    regexp: "^gem: --user-install"
    line: "gem: --no-user-install"
    backrefs: yes
    backup: yes
  tags: ['gems']

#TODO: account for using RVM

- name: Get list of installed gems
  shell: |
    sudo gem list | awk '{ print $1 }'
  register: gemlist
  ignore_errors: yes
  become: True
  become_user: "{{ user.name }}"

- set_fact:
    installed_gems: "{{ gemlist.stdout }}"

- name: determine gems that need to be installed
  set_fact:
    _gems: "{{ gems|difference(installed_gems) }}"

- name: install ruby gems
  shell: |
    sudo gem install {{ item }}
  with_items:
    - "{{ _gems }}"
  when: _gems | length > 0
  become: True
  become_user: "{{ user.name }}"

- name: use shell to do stuff
  shell: |
    bundle config set --local system 'true'
  become: True
  become_user: "{{ user.name }}"
