---

- name: Update user shell defined in group_vars/all
  user:
    name: "{{ item }}"
    shell: /bin/zsh
  with_items:
    - root
    - "{{ user.name }}"
  tags: ['dots']

- name: Check if oh-my-zsh is already installed
  stat: path="/usr/share/oh-my-zsh"
  register: haziohymyzsh
  tags: ['dots']

- block:
    - name: Clone oh-my-zsh
      git:
        repo: "https://github.com/ohmyzsh/ohmyzsh.git"
        dest: "{{ local_src }}/ohmyzsh"
        accept_hostkey: yes
        update: no
        force: no

    - name: Install oh-my-zsh
      shell: |
        export ZSH="/usr/share/oh-my-zsh" && \
        sh -c './install.sh --unattended'
      args:
        chdir: "{{ local_src }}/ohmyzsh/tools/"

  when: not haziohymyzsh.stat.exists
  check_mode: no

- name: create zsh custom themes dir
  file:
    path: /usr/share/oh-my-zsh/custom/themes
    state: directory
    mode: '0775'
  tags: ['dots']
  check_mode: no

- name: Push oh-my-zsh-theme template
  template:
    src: "usr/share/oh-my-zsh/themes/{{ zsh.theme }}.zsh-theme.j2"
    dest: "/usr/share/oh-my-zsh/themes/{{ zsh.theme }}.zsh-theme"
    owner: root
    group: root
    mode: '0644'
  tags: ['dots']

- name: Push root zshell config
  synchronize:
    src: "root/"
    dest: "/root/"
    recursive: yes
    mode: push
    delete: no
    checksum: yes
    perms: no
    rsync_opts: "--update"
  tags: ['dots']

- name: set perms for root home
  shell: "chown -R root:root /root"
  tags: ['dots']

- block:
    - name: Push user zshell templates
      template:
        src: "dots/{{ item }}.j2"
        dest: "{{ user.home }}/.{{ item }}"
        owner: "{{ user.name }}"
        group: "{{ user.group }}"
        mode: "0644"
        backup: no
      with_items:
        - "aliases"
        - "gitconfig"
        - "zlogin"
        - "zshenv"
        - "zshrc"

  become: True
  become_user: "{{ user.name }}"
  tags: ['zsh', 'dots']
