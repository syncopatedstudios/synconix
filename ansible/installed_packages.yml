---

# this won't work because no matter what,
# _packagelist is overwritten by the last thing
# that trys to register it.

# except, if you put set_fact within each block...

- hosts: all, localhost
  gather_facts: false
  run_once: true
  tasks:
    - block:
        - name: gather facts
          setup:
            gather_subset:
              - os_family
              - pkg_mgr

        - set_fact:
            package_manager: "{{ ansible_pkg_mgr }}"
            distro_family: "{{ ansible_os_family }}"

        - block:
            - name: Get installed items list
              shell: |
                dnf list --installed | awk -F '.' '{ print $1}'
              register: _packagelist
              check_mode: no
              ignore_errors: yes

            - set_fact:
                installed_packages: "{{ _packagelist.stdout }}"
              when: _packagelist | length > 0

          when:
            - "distro_family == 'RedHat'"
            - "package_manager == 'dnf'"

        - block:
            - name: Gather list of currently installed packages
              shell: |
                apt list --installed | cut -f1 -d / | tr "\n" " "
              register: _packagelist
              check_mode: no
              ignore_errors: yes

            - set_fact:
                installed_packages: "{{ _packagelist.stdout }}"
              when: _packagelist | length > 0

          when:
            - "distro_family == 'Debian'"
            - "package_manager == 'apt'"



      tags: ['always', 'packagelist']
