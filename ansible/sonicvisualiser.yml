---

- hosts: all
  gather_facts: yes
  vars:
    env_vars:
      PATH: "{{ ansible_env.PATH }}:{{ path|join(':') }}"

  pre_tasks:
    - name: Load Fedora
      include_role:
        name: distro/fedora
      when: "ansible_facts['os_family'] == 'RedHat'"
      tags: ['facts', 'common', 'soundbot', 'ui', 'audio']

    - name: Load Debian
      include_role:
        name: distro/debian
      when: "ansible_facts['os_family'] == 'Debian'"
      tags: ['facts', 'common', 'soundbot', 'ui', 'audio']

  tasks:
    - name: check if sonic-visualiser is already installed
      stat: path="/usr/local/bin/sonic-visualiser"
      register: hazivisualiser
      tags: ['sonic-visualiser']

    - name: set packages to install
      set_fact:
        _dev_sonicvisualiser: "{{ development['sonicvisualiser']|difference(installed_packages) }}"
      tags: ['packages']

    - name: install sonicvisualiser deps
      shell: "{{ ansible_pkg_mgr }} -y install {{ _dev_sonicvisualiser | join(' ') }}"
      when: _dev_sonicvisualiser|length>0
      tags: ['packages']

    - block:
        - name: clone sonic-visualiser
          git:
            repo: "https://github.com/sonic-visualiser/sonic-visualiser"
            dest: "/usr/local/src/sonic-visualiser"
            accept_hostkey: yes
            update: no
            force: no

        - name: build sonic-visualiser
          shell: |
            ./repoint install

            meson build

            cd build/ && ninja

            sudo meson install
          args:
            chdir: "/usr/local/src/sonic-visualiser"
      become: True
      become_user: "{{ user.name }}"
      when: not hazivisualiser.stat.exists
      tags: ['sonic-visualiser']
