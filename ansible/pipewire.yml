---

- hosts: all
  gather_facts: yes
  vars:
    env_vars:
      PATH: "{{ ansible_env.PATH }}:{{ path|join(':') }}"

  pre_tasks:
    - name: Load Distro stuff
      include_role:
        name: distro

  tasks:

    - name: Load common install vars
      include_vars: "/opt/soundbot/ansible/roles/distro/vars/{{ ansible_os_family }}.yml"

    - name: install libcamera dependecies
      shell: "{{ ansible_pkg_mgr }} -y install {{ deps['libcamera'] | join(' ') }}"

    - name: install pipewire deps
      shell: "{{ ansible_pkg_mgr }} -y install {{ deps['pipewire'] | join(' ') }}"


    - block:
        - name: clone libcamera
          git:
            repo: "https://git.libcamera.org/libcamera/libcamera.git"
            dest: "/usr/local/src/libcamera"
            accept_hostkey: yes
            update: no
            force: no

        - name: build libcamera
          shell: |
            meson build -Dprefix=/usr

            sudo ninja -C build install
          args:
            chdir: "/usr/local/src/libcamera"

        - name: clone pipewire
          git:
            repo: "https://gitlab.freedesktop.org/pipewire/pipewire.git"
            dest: "/usr/local/src/pipewire"
            accept_hostkey: yes
            update: no
            force: no

        - name: build pipewire
          shell: |
            meson setup builddir

            meson configure builddir -Dprefix=/usr

            ninja -C builddir
          args:
            chdir: "/usr/local/src/pipewire"
      become: True
      become_user: "{{ user.name }}"
      tags: ['pipewire']
