---

- hosts: all
  gather_facts: yes
  vars:
    dependecies:
      - bzip2-devel
      - capnproto
      - capnproto-devel
      - fftw-devel
      - libfishsound-devel
      - libid3tag-devel
      - liblo-devel
      - liblrdf-devel
      - libmad-devel
      - liboggz-devel
      - libsamplerate-devel
      - libsndfile-devel
      - libtool
      - libxml2-devel
      - mercurial
      - meson
      - ninja-build
      - opusfile-devel
      - polyml
      - portaudio-devel
      - qt5-qtsvg-devel
      - raptor2-devel
      - rubberband-devel
      - sord-devel
    env_vars:
      PATH: "{{ ansible_env.PATH }}:{{ path|join(':') }}"

  tasks:
    - name: check if sonic-visualiser is already installed
      stat: path="/usr/local/bin/sonic-visualiser"
      register: hazivisualiser
      tags: ['sonic-visualiser']

    - name: install visualiser deps
      shell: "{{ ansible_pkg_mgr }} -y install {{ dependecies | join(' ') }}"

    - block:
        - name: clone sonic-visualiser
          git:
            repo: "https://github.com/sonic-visualiser/sonic-visualiser"
            dest: "/usr/local/src/sonic-visualiser"
            accept_hostkey: yes
            update: no
            force: no

        - name: build sonic-visualiser
          shell: |
            ./repoint install

            meson build

            cd build/ && ninja

            sudo meson install
          args:
            chdir: "/usr/local/src/sonic-visualiser"
      become: True
      become_user: "{{ user.name }}"
      when: not hazivisualiser.stat.exists
      tags: ['sonic-visualiser']
